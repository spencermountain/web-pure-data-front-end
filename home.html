<head>
<script src='pd.js' type='text/javascript'></script>
<script src='ejs.js' type='text/javascript'></script>
<script src="underscore.js"></script>
	
	<divnk rel="stylesheet" href="./ui/jquery.ui.all.css">
	<script src="./ui/jquery.js"></script>
	<script src="./ui/jquery.ui.core.js"></script>
	<script src="./ui/jquery.ui.widget.js"></script>
	<script src="./ui/jquery.ui.mouse.js"></script>
	<script src="./ui/jquery.ui.draggable.js"></script>
	<script src="./ui/jquery.ui.droppable.js"></script>
	<script src="./ui/jquery.ui.selectable.js"></script>
	
	
<script>
$(document).ready(function() {
pd=null;
reload();

$("#reload").click(function(){
  reload();
})

$("#dump").click(function(){
    console.log(pd);
})



function reload(){
  if(pd){
    pd.stop();
    pd=null;
  }
   var patch=$("#source").val();
   pd = new Pd(44100, 4410, true);
   pd.loadfromstring(patch, pd.stop);


		  //setup the pdobject for rendering
      var html='';
		  for (var o in pd._graph.objects) {
		    pd._graph.objects[o].x=pd._graph.objects[o].args[2];
		    pd._graph.objects[o].y=pd._graph.objects[o].args[3];	
		    pd._graph.objects[o].title=set_title(pd._graph.objects[o]);
		    pd._graph.objects[o].id=_.uniqueId('guid_')
        html+=makeobject(pd._graph.objects[o]);
		  }


pd.addlistener('fun', pd._graph.objects[0])

    
  $("#stage").html(html);

  $( ".draggable" ).draggable({stop:function(ev, ui){
    //update coordinates
    var id=$(this).attr('id');
    for(var i in pd._graph.objects){
      if(pd._graph.objects[i].id==id){
         pd._graph.objects[i].x=ui.position.left;
         pd._graph.objects[i].y=ui.position.top;
         break;
      }
    }
  }});
	

}



function makeobject(pdobj){
  //console.log(pdobj);   
   if(pdobj.type=="tgl"){ 
    return new EJS({url: './templates/checkbox.ejs'}).render({obj:pdobj});
   }
    if(pdobj.type=="msg"){ 
    return new EJS({url: './templates/message.ejs'}).render({obj:pdobj});
   }
   //generic object
  return new EJS({url: './templates/normal_object.ejs'}).render({obj:pdobj});
}


//what to actually display
function set_title(pdobj){
  if(pdobj.type=="msg"){
    return pdobj.title=pdobj.args.slice(4, pdobj.args.length).join(" ");  
  }
  return pdobj.args[4];
}

});

function findbyid(id){
    for(var i in pd._graph.objects){
      if( pd._graph.objects[i].id==id){
      return  pd._graph.objects[i];
      }
    }
  return {};
}

</script>

</head>
<body>

<div id="stage" style="position:absolute;">
</div>

<div style="position:absolute; top:200px; left:600px;">
<textarea id="source" style="height:400px; width:500px;">
#N canvas 67 83 450 300 10;
#X obj 116 72 tgl 15 0 empty empty empty 17 7 0 10 -262144 -1 -1 0
1;
#N canvas 322 248 450 300 fun 1;
#X obj 146 25 inlet;
#X obj 136 147 outlet;
#X msg 144 76 hio;
#X connect 0 0 2 0;
#X connect 2 0 1 0;
#X restore 132 107 pd fun;
#X obj 131 152 print;
#X connect 0 0 1 0;
#X connect 1 0 2 0;
</textarea>
<input type="submit" id="reload" value="load"/>
<input type="submit" id="dump" value="dump"/>
</div>

<div style="position:absolute; bottom:0px">
            <input type='button' value='play' onclick='javascript: pd.play();' />
            <input type='button' value='pause' onclick='javascript: pd.stop();' />
            <br/>
            console:
            <br/>
            <span id='golden'>
            </span>
            <pre id='console' style="font-size:12px;">
            </pre>
            <span class="debug" id='debug'>
            </span>
            </div>
                            </body>
